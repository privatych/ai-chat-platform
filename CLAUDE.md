–û—Ç–ª–∏—á–Ω–æ! –û—Ç–≤–µ—á—É –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∫–∞–∫ senior architect, –∑–∞—Ç–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude Code.

***

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã

## üì± –ú–æ–±–∏–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

**1. –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã: iOS + Android (–æ–±–µ)**
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞
- **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** AI-—á–∞—Ç—ã - –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –º–æ–±–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (70%+ —Ç—Ä–∞—Ñ–∏–∫–∞)[1]

**2. –§—Ä–µ–π–º–≤–æ—Ä–∫: React Native (Expo SDK 52)**
- **–ü—Ä–∏—á–∏–Ω—ã:** 
  - –ï–¥–∏–Ω–∞—è –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞ (—ç–∫–æ–Ω–æ–º–∏—è 60% –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
  - Expo managed workflow - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –±–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  - OTA updates –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ñ–∏–∫—Å–æ–≤ –±–µ–∑ App Store review
  - –ë–æ–ª—å—à–æ–µ –∫–æ–º—å—é–Ω–∏—Ç–∏ + –≥–æ—Ç–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è AI features
  - Sharing –∫–æ–¥–∞ —Å Next.js web –≤–µ—Ä—Å–∏–µ–π (React + TS)
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç–∞:** Flutter (–º–µ–Ω—å—à–µ web code reuse), Native (2x –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

**3. IDE: VS Code (primary) + Xcode (iOS simulator)**
- **VS Code:** –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (TS/JS/React)
- **Xcode:** —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ iOS simulator –∏ —Å–±–æ—Ä–∫–∏ —Ä–µ–ª–∏–∑–æ–≤
- **Android Studio:** –Ω–µ –Ω—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Expo CLI + Android Emulator
- **–†–∞—Å—à–∏—Ä–µ–Ω–∏—è:** ESLint, Prettier, React Native Tools, Expo Tools

***

## üîß Backend / SaaS

**4. Backend: Node.js + Fastify (TypeScript)**
- **Fastify –≤–º–µ—Å—Ç–æ Express:** 3x –±—ã—Å—Ç—Ä–µ–µ, –Ω–∞—Ç–∏–≤–Ω—ã–π TypeScript support, schema validation
- **–ü–æ—á–µ–º—É Node.js:** 
  - Sharing —Ç–∏–ø–æ–≤ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º (monorepo)
  - –û—Ç–ª–∏—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SSE (Server-Sent Events) –¥–ª—è streaming
  - –ë–æ–ª—å—à–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è AI/LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
  - Team expertise (JavaScript full-stack)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –≤ Docker
  ```
  services/
  ‚îú‚îÄ‚îÄ api-gateway/      # Fastify (main API)
  ‚îú‚îÄ‚îÄ auth-service/     # Appwrite
  ‚îú‚îÄ‚îÄ chat-service/     # –û–±—Ä–∞–±–æ—Ç–∫–∞ LLM –∑–∞–ø—Ä–æ—Å–æ–≤
  ‚îú‚îÄ‚îÄ payment-service/  # YooKassa integration
  ‚îî‚îÄ‚îÄ analytics/        # Tracking & metrics
  ```

**5. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL 15 + Redis**
- **PostgreSQL:** 
  - –û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (users, chats, messages, subscriptions)
  - pgvector extension –¥–ª—è semantic search –ø–æ —á–∞—Ç–∞–º
  - JSONB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è metadata –º–æ–¥–µ–ª–∏
- **Redis:**
  - Rate limiting (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ abuse)
  - Session storage
  - Cache –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
  - Pub/Sub –¥–ª—è real-time events

**6. Web —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: Next.js 15 (App Router)**
- **Next.js –≤–º–µ—Å—Ç–æ —á–∏—Å—Ç–æ–≥–æ React:**
  - SSR –¥–ª—è SEO (landing page, blog)
  - API routes –¥–ª—è webhook handlers
  - Edge runtime –¥–ª—è geographic optimization
  - Image optimization –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- **Sharing –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:** 80% UI components –æ–±—â–∏–µ —Å React Native —á–µ—Ä–µ–∑ react-native-web

**7. ORM: Drizzle ORM**
- **Drizzle –≤–º–µ—Å—Ç–æ Prisma:**
  - –õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π (–º–µ–Ω—å—à–µ bundle size)
  - SQL-like —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–ø–æ–Ω—è—Ç–Ω–µ–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã)
  - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  - TypeScript-first
- **Migrations:** drizzle-kit –¥–ª—è auto-generation
- **Schema example:**
  ```typescript
  export const chats = pgTable('chats', {
    id: uuid('id').primaryKey().defaultRandom(),
    userId: uuid('user_id').references(() => users.id),
    title: text('title'),
    model: text('model'), // 'gpt-4', 'claude-3.5-sonnet'
    createdAt: timestamp('created_at').defaultNow(),
  });
  ```

***

## üèóÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**8. Docker: –î–∞, docker-compose –¥–ª—è dev + Kubernetes-ready –¥–ª—è prod**
- **docker-compose.yml** –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
  ```yaml
  services:
    postgres:
      image: pgvector/pgvector:latest
    redis:
      image: redis:7-alpine
    api:
      build: ./services/api-gateway
      depends_on: [postgres, redis]
    appwrite:
      image: appwrite/appwrite:1.5
  ```
- **Production:** Railway (managed containers) –∏–ª–∏ Fly.io (global edge deployment)

**9. Package manager: pnpm**
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
  - –≠–∫–æ–Ω–æ–º–∏—è –¥–∏—Å–∫–∞ (content-addressable storage)
  - –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
  - Strict node_modules (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç phantom dependencies)
  - Monorepo workspace support
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã:** npm (–º–µ–¥–ª–µ–Ω–Ω—ã–π), yarn (legacy), bun (–µ—â–µ –Ω–µ stable –¥–ª—è production)

**10. CI/CD: GitHub Actions**
- **–ü–∞–π–ø–ª–∞–π–Ω—ã:**
  ```yaml
  # .github/workflows/main.yml
  - Lint & Type Check (ESLint, TypeScript)
  - Unit Tests (Jest, 70% coverage threshold)
  - Build mobile (Expo EAS Build –¥–ª—è iOS/Android)
  - Build web (Next.js)
  - Deploy (Railway/Vercel)
  - E2E tests (Playwright –¥–ª—è critical paths)
  ```
- **Triggers:** push to main/develop, pull requests
- **Secrets:** GitHub Secrets –¥–ª—è API keys (OpenRouter, YooKassa)

**11. Monorepo: Turborepo**
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
  ```
  /
  ‚îú‚îÄ‚îÄ apps/
  ‚îÇ   ‚îú‚îÄ‚îÄ mobile/          # Expo app
  ‚îÇ   ‚îú‚îÄ‚îÄ web/             # Next.js app
  ‚îÇ   ‚îî‚îÄ‚îÄ admin/           # Admin dashboard (Next.js)
  ‚îú‚îÄ‚îÄ packages/
  ‚îÇ   ‚îú‚îÄ‚îÄ ui/              # Shared React components
  ‚îÇ   ‚îú‚îÄ‚îÄ api-client/      # Type-safe API client
  ‚îÇ   ‚îú‚îÄ‚îÄ database/        # Drizzle schemas
  ‚îÇ   ‚îî‚îÄ‚îÄ utils/           # Shared utilities
  ‚îî‚îÄ‚îÄ services/
      ‚îî‚îÄ‚îÄ api/             # Fastify backend
  ```
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** Sharing –∫–æ–¥–∞, centralized dependencies, parallel builds

***

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–∞—á–µ—Å—Ç–≤–æ

**12. Testing strategy:**
- **Unit tests (Jest + Testing Library):**
  - UI components (React Native Testing Library)
  - Utility functions
  - API handlers
  - Target: 70% coverage
- **Integration tests (Jest + Supertest):**
  - API endpoints
  - Database operations
  - Auth flows
- **E2E tests (Detox –¥–ª—è mobile + Playwright –¥–ª—è web):**
  - Critical user flows: Sign up ‚Üí First chat ‚Üí Upgrade
  - Payment flow
  - Model switching
  - **–ó–∞–ø—É—Å–∫:** Nightly –Ω–∞ CI, –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
- **Visual regression (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** Chromatic –¥–ª—è Storybook components

**13. Linting & Formatting: ESLint + Prettier**
- **ESLint config:**
  ```json
  {
    "extends": [
      "next/core-web-vitals",
      "@react-native-community",
      "plugin:@typescript-eslint/recommended",
      "prettier"
    ],
    "rules": {
      "no-console": "warn",
      "@typescript-eslint/no-unused-vars": "error"
    }
  }
  ```
- **Prettier config:** 2 spaces, single quotes, trailing commas
- **Pre-commit hook (Husky):**
  ```bash
  npx lint-staged  # –ª–∏–Ω—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  npm test -- --findRelatedTests  # —Ç–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
  ```

***

## ü§ñ –ê–≥–µ–Ω—Ç—ã –∏ workflow

**14. –ó–∞–¥–∞—á–∏ –∞–≥–µ–Ω—Ç–æ–≤ (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):**
1. **Code generation** - –Ω–∞–ø–∏—Å–∞–Ω–∏–µ boilerplate –∫–æ–¥–∞ (API routes, DB schemas)
2. **Code review** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π review PR –ø–µ—Ä–µ–¥ merge
3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - auto-generation JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, README updates
4. **Testing** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è unit tests –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
5. **–î–µ–ø–ª–æ–π** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π deploy –Ω–∞ staging –ø—Ä–∏ merge –≤ develop
6. **Bug fixing** - –∞–Ω–∞–ª–∏–∑ Sentry errors –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ fixes

**15. –£—Ä–æ–≤–µ–Ω—å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç–∏: Hybrid (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è + approval gates)**
- **–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–µ:**
  - Lint fixes
  - Prettier formatting
  - Dependency updates (minor versions)
  - Deploy –Ω–∞ staging
- **–° –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º:**
  - Deploy –Ω–∞ production
  - Breaking changes –≤ API
  - Database migrations
  - Major dependency updates
- **–¢–æ–ª—å–∫–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
  - –í—ã–±–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
  - Refactoring large codebase

**16. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç: –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω—É–ª—è (greenfield)**
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫, no legacy code
- **–ü–ª–∞–Ω:** MVP –∑–∞ 6-8 –Ω–µ–¥–µ–ª—å, iterative development

**17. API/–°–µ—Ä–≤–∏—Å—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
- **OpenRouter** - unified LLM API (GPT, Claude, Gemini, DeepSeek, Grok)
- **Appwrite** - Auth (OAuth —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏), Database, Storage, Functions
- **YooKassa** - –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –†–§ (–∫–∞—Ä—Ç—ã, –ÆMoney, SberPay)
- **Stripe** - –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è global expansion)
- **Sentry** - error tracking & performance monitoring
- **PostHog** - analytics & feature flags
- **ElevenLabs** - TTS –¥–ª—è voice features (premium)
- **Resend** - transactional emails (welcome, payment confirmation)

**18. Realtime: –î–∞, Server-Sent Events (SSE)**
- **Use cases:**
  - Streaming LLM responses (word-by-word typing)
  - Typing indicators
  - New message notifications
  - Subscription status updates
- **–ü–æ—á–µ–º—É SSE –≤–º–µ—Å—Ç–æ WebSockets:**
  - –ü—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (HTTP-based)
  - Auto-reconnect –∏–∑ –∫–æ—Ä–æ–±–∫–∏
  - –ú–µ–Ω—å—à–µ overhead –¥–ª—è one-way communication
  - –•–æ—Ä–æ—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Fastify + React Query
- **Implementation:**
  ```typescript
  // Backend (Fastify)
  app.get('/chat/stream', async (req, reply) => {
    reply.raw.setHeader('Content-Type', 'text/event-stream');
    for await (const chunk of openRouterStream) {
      reply.raw.write(` ${JSON.stringify(chunk)}\n\n`);
    }
  });
  
  // Frontend (React Query)
  const { data } = useQuery({
    queryKey: ['chat-stream', messageId],
    queryFn: () => fetchEventSource('/chat/stream'),
  });
  ```

***

# üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude Code

```markdown
# AI Chat Platform - –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Claude Code

## –†–æ–ª—å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
–¢—ã - senior full-stack –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ multi-agent —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∫—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–π AI chat –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º LLM –º–æ–¥–µ–ª—è–º (ChatGPT, Claude, Gemini, DeepSeek, Grok) —á–µ—Ä–µ–∑ OpenRouter API —Å freemium –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å—é.

## –ö–ª—é—á–µ–≤—ã–µ —Ü–µ–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
1. **Time to first value < 60 —Å–µ–∫—É–Ω–¥** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç AI –∑–∞ –º–∏–Ω—É—Ç—É –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
2. **Free to paid conversion > 7%** - –∫–æ–Ω–≤–µ—Ä—Å–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
3. **Mobile-first experience** - 70% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
4. **Multi-model flexibility** - –ª–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É AI –º–æ–¥–µ–ª—è–º–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Frontend
- **Web:** Next.js 15 (App Router) + TypeScript + Tailwind CSS + shadcn/ui
- **Mobile:** React Native (Expo SDK 52) + TypeScript
- **Shared UI:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ react-native-web
- **State Management:** Zustand –¥–ª—è client state + TanStack Query –¥–ª—è server state
- **Forms:** React Hook Form + Zod validation
- **Styling:** Tailwind CSS (web) + NativeWind (mobile)

### Backend
- **Framework:** Node.js + Fastify + TypeScript
- **Database:** PostgreSQL 15 + pgvector extension –¥–ª—è semantic search
- **Cache:** Redis –¥–ª—è rate limiting, sessions, caching
- **ORM:** Drizzle ORM –¥–ª—è type-safe queries
- **Auth:** Appwrite (OAuth: Google, Yandex, VK, Telegram)
- **Realtime:** Server-Sent Events (SSE) –¥–ª—è streaming LLM responses

### Infrastructure
- **Monorepo:** Turborepo –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è apps/packages/services
- **Package Manager:** pnpm –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ disk efficiency
- **Containerization:** Docker + docker-compose –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **CI/CD:** GitHub Actions (lint, test, build, deploy)
- **Hosting:** 
  - Web: Vercel (Next.js)
  - API: Railway –∏–ª–∏ Fly.io (Fastify –≤ Docker)
  - Database: Railway PostgreSQL –∏–ª–∏ Supabase
  - Mobile: Expo EAS (build + updates)

### External APIs
- **OpenRouter** - unified LLM API –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- **YooKassa** - –ø–ª–∞—Ç–µ–∂–∏ (–†–§ —Ä—ã–Ω–æ–∫)
- **Appwrite** - BaaS (auth, database, storage, functions)
- **Sentry** - error tracking
- **PostHog** - product analytics –∏ feature flags
- **ElevenLabs** - text-to-speech (premium feature)
- **Resend** - transactional emails

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### Monorepo —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
ai-chat-platform/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ web/                    # Next.js web app
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/                # App Router pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/         # Web-specific components
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ mobile/                 # Expo React Native app
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/                # Expo Router screens
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/         # Mobile-specific components
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.json
‚îÇ   ‚îî‚îÄ‚îÄ admin/                  # Admin dashboard (Next.js)
‚îÇ       ‚îî‚îÄ‚îÄ app/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                     # Shared React components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ atoms/          # Button, Input, Badge
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ molecules/      # SearchBar, MessageBubble
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ organisms/      # ChatInterface, ModelSelector
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/      # PageLayouts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ api-client/             # Type-safe API client (tRPC –∏–ª–∏ OpenAPI generated)
‚îÇ   ‚îú‚îÄ‚îÄ database/               # Drizzle schemas –∏ migrations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chats.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscriptions.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Shared configs (ESLint, TS, Tailwind)
‚îÇ   ‚îî‚îÄ‚îÄ utils/                  # Shared utilities –∏ helpers
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ api/                    # Main Fastify API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/         # API endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.ts     # Chat CRUD + streaming
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts     # Authentication
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.ts     # User management
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscription.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openrouter.service.ts    # OpenRouter integration
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.service.ts       # YooKassa
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analytics.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts     # JWT verification
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rateLimit.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ analytics/              # Analytics microservice (optional)
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.dev.yml  # Local development
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.prod.yml
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ci.yml              # Lint + Test + Build
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml          # Auto deploy
‚îú‚îÄ‚îÄ turbo.json                  # Turborepo configuration
‚îú‚îÄ‚îÄ pnpm-workspace.yaml
‚îî‚îÄ‚îÄ package.json
```

---

## Database Schema (Drizzle ORM)

### Core Tables
```typescript
// packages/database/schema/users.ts
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: text('email').unique().notNull(),
  name: text('name'),
  avatarUrl: text('avatar_url'),
  subscriptionTier: text('subscription_tier').default('free'), // 'free' | 'premium'
  subscriptionExpiresAt: timestamp('subscription_expires_at'),
  freeMessagesUsedToday: integer('free_messages_used_today').default(0),
  preferences: jsonb('preferences').$type<UserPreferences>(),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// packages/database/schema/chats.ts
export const chats = pgTable('chats', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }),
  title: text('title').notNull(),
  model: text('model').notNull(), // 'gpt-4', 'claude-3.5-sonnet', etc.
  isPinned: boolean('is_pinned').default(false),
  isArchived: boolean('is_archived').default(false),
  folderId: uuid('folder_id').references(() => folders.id),
  systemPrompt: text('system_prompt'),
  meta jsonb('metadata').$type<ChatMetadata>(),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// packages/database/schema/messages.ts
export const messages = pgTable('messages', {
  id: uuid('id').primaryKey().defaultRandom(),
  chatId: uuid('chat_id').references(() => chats.id, { onDelete: 'cascade' }),
  role: text('role').notNull(), // 'user' | 'assistant' | 'system'
  content: text('content').notNull(),
  model: text('model'), // –º–æ–¥–µ–ª—å –∫–æ—Ç–æ—Ä–∞—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –æ—Ç–≤–µ—Ç (–¥–ª—è assistant)
  tokensUsed: integer('tokens_used'),
  attachments: jsonb('attachments').$type<Attachment[]>(),
  branchId: uuid('branch_id'), // –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ branching
  parentMessageId: uuid('parent_message_id'),
  feedback: text('feedback'), // 'positive' | 'negative'
  createdAt: timestamp('created_at').defaultNow(),
});

// packages/database/schema/folders.ts
export const folders = pgTable('folders', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }),
  name: text('name').notNull(),
  color: text('color'),
  createdAt: timestamp('created_at').defaultNow(),
});

// packages/database/schema/subscriptions.ts
export const subscriptions = pgTable('subscriptions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }),
  provider: text('provider').notNull(), // 'yookassa' | 'stripe'
  providerId: text('provider_id').unique(), // ID –∏–∑ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
  status: text('status').notNull(), // 'active' | 'canceled' | 'past_due'
  plan: text('plan').notNull(), // 'premium'
  priceAmount: integer('price_amount'), // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency: text('currency').default('RUB'),
  currentPeriodStart: timestamp('current_period_start'),
  currentPeriodEnd: timestamp('current_period_end'),
  cancelAtPeriodEnd: boolean('cancel_at_period_end').default(false),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// packages/database/schema/memory.ts (–¥–ª—è cross-chat memory - premium)
export const userMemory = pgTable('user_memory', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }),
  key: text('key').notNull(), // 'user_profession', 'user_name'
  value: text('value').notNull(),
  source: text('source'), // –æ—Ç–∫—É–¥–∞ –∏–∑–≤–ª–µ—á–µ–Ω–æ (chat_id)
  createdAt: timestamp('created_at').defaultNow(),
});
```

---

## API Endpoints (Fastify Routes)

### Chat Management
```typescript
// services/api/src/routes/chat.ts
POST   /api/chats              # Create new chat
GET    /api/chats              # List all chats (with pagination)
GET    /api/chats/:id          # Get chat with messages
PATCH  /api/chats/:id          # Update chat (title, pin, archive)
DELETE /api/chats/:id          # Delete chat
GET    /api/chats/search       # Search in chats (query param)

POST   /api/chats/:id/messages # Send message + stream response (SSE)
GET    /api/messages/:id       # Get specific message
PATCH  /api/messages/:id       # Edit message (triggers regeneration)
POST   /api/messages/:id/regenerate  # Regenerate response
POST   /api/messages/:id/feedback    # Submit üëçüëé
```

### User & Subscription
```typescript
GET    /api/user               # Get current user profile
PATCH  /api/user               # Update user preferences
POST   /api/user/memory        # Add/update memory fact
DELETE /api/user/memory/:id    # Delete memory fact

POST   /api/subscribe          # Create subscription (YooKassa)
GET    /api/subscription       # Get subscription status
POST   /api/subscription/cancel # Cancel subscription
POST   /api/webhooks/yookassa  # YooKassa webhook handler
```

### Models & Analytics
```typescript
GET    /api/models             # List available models from OpenRouter
GET    /api/analytics          # User usage stats (messages, tokens, cost)
```

---

## Frontend Architecture

### Web App (Next.js)

#### App Router Structure
```typescript
// apps/web/app/layout.tsx - Root layout
export default function RootLayout({ children }) {
  return (
    <html lang="ru">
      <body>
        <Providers>
          <Toaster />
          {children}
        </Providers>
      </body>
    </html>
  );
}

// apps/web/app/page.tsx - Landing page (public)
// apps/web/app/login/page.tsx - Auth page
// apps/web/app/chat/layout.tsx - Chat app layout (sidebar + main)
// apps/web/app/chat/page.tsx - Chat list –∏–ª–∏ new chat
// apps/web/app/chat/[chatId]/page.tsx - Specific chat
// apps/web/app/settings/page.tsx - User settings
// apps/web/app/pricing/page.tsx - Pricing page
```

#### Key Components
```typescript
// packages/ui/src/organisms/ChatInterface.tsx
export function ChatInterface({ chatId }: { chatId: string }) {
  const {  chat } = useChat(chatId);
  const { mutate: sendMessage, isLoading } = useSendMessage(chatId);
  const [input, setInput] = useState('');

  return (
    <div className="flex flex-col h-screen">
      <ChatHeader chat={chat} />
      <MessageList messages={chat?.messages} />
      <MessageInput 
        value={input}
        onChange={setInput}
        onSend={() => sendMessage({ content: input })}
        isLoading={isLoading}
      />
    </div>
  );
}

// packages/ui/src/molecules/MessageBubble.tsx
export function MessageBubble({ message }: { message: Message }) {
  const isUser = message.role === 'user';
  
  return (
    <div className={cn('flex gap-3', isUser && 'flex-row-reverse')}>
      <Avatar model={message.model} />
      <div className="flex flex-col gap-1">
        <Markdown content={message.content} />
        {message.role === 'assistant' && (
          <MessageActions 
            onCopy={() => copy(message.content)}
            onRegenerate={() => regenerate(message.id)}
            onFeedback={(type) => submitFeedback(message.id, type)}
          />
        )}
      </div>
    </div>
  );
}

// packages/ui/src/molecules/ModelSelector.tsx
export function ModelSelector({ value, onChange }: ModelSelectorProps) {
  const {  models } = useModels();
  
  return (
    <Select value={value} onValueChange={onChange}>
      {models?.map(model => (
        <SelectItem key={model.id} value={model.id}>
          <div className="flex items-center gap-2">
            <ModelIcon model={model.id} />
            <div>
              <div className="font-medium">{model.name}</div>
              <div className="text-xs text-muted-foreground">
                {model.speed} -  {model.cost}
              </div>
            </div>
          </div>
        </SelectItem>
      ))}
    </Select>
  );
}
```

### Mobile App (Expo)

#### Expo Router Structure
```typescript
// apps/mobile/app/_layout.tsx - Root layout
export default function RootLayout() {
  return (
    <Stack>
      <Stack.Screen name="(auth)" options={{ headerShown: false }} />
      <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
    </Stack>
  );
}

// apps/mobile/app/(auth)/login.tsx - Login screen
// apps/mobile/app/(tabs)/_layout.tsx - Tab navigator
// apps/mobile/app/(tabs)/index.tsx - Home/New chat
// apps/mobile/app/(tabs)/chats.tsx - Chat list
// apps/mobile/app/(tabs)/settings.tsx - Settings
// apps/mobile/app/chat/[id].tsx - Chat screen
```

#### Key Screens
```typescript
// apps/mobile/app/chat/[id].tsx
export default function ChatScreen() {
  const { id } = useLocalSearchParams();
  const {  chat } = useChat(id as string);
  
  return (
    <KeyboardAvoidingView behavior="padding">
      <FlatList
        data={chat?.messages}
        renderItem={({ item }) => <MessageBubble message={item} />}
        inverted
      />
      <MessageInput chatId={id as string} />
    </KeyboardAvoidingView>
  );
}

// apps/mobile/app/(tabs)/chats.tsx
export default function ChatsScreen() {
  const {  chats } = useChats();
  
  return (
    <SwipeListView
      data={chats}
      renderItem={({ item }) => <ChatListItem chat={item} />}
      renderHiddenItem={({ item }) => (
        <HiddenActions
          onArchive={() => archiveChat(item.id)}
          onDelete={() => deleteChat(item.id)}
        />
      )}
      rightOpenValue={-150}
    />
  );
}
```

---

## Backend Implementation

### OpenRouter Integration
```typescript
// services/api/src/services/openrouter.service.ts
import OpenAI from 'openai';

export class OpenRouterService {
  private client = new OpenAI({
    baseURL: 'https://openrouter.ai/api/v1',
    apiKey: process.env.OPENROUTER_API_KEY,
    defaultHeaders: {
      'HTTP-Referer': process.env.APP_URL,
      'X-Title': 'AI Chat Platform',
    },
  });

  async *streamChat(messages: Message[], model: string) {
    const stream = await this.client.chat.completions.create({
      model,
      messages,
      stream: true,
    });

    for await (const chunk of stream) {
      const content = chunk.choices?.delta?.content;
      if (content) yield content;
    }
  }

  async getAvailableModels() {
    const response = await fetch('https://openrouter.ai/api/v1/models', {
      headers: { Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}` },
    });
    return response.json();
  }
}
```

### Chat Streaming Route
```typescript
// services/api/src/routes/chat.ts
app.post('/chats/:id/messages', async (req, reply) => {
  const { chatId } = req.params;
  const { content } = req.body;
  const user = req.user; // from auth middleware

  // Check rate limits
  if (user.subscriptionTier === 'free') {
    const used = await getRateLimitUsage(user.id);
    if (used >= 50) {
      throw new Error('Daily limit reached. Upgrade to premium.');
    }
  }

  // Get chat context
  const chat = await db.query.chats.findFirst({
    where: eq(chats.id, chatId),
    with: { messages: { orderBy: messages.createdAt } },
  });

  // Add user memory to context (premium feature)
  const memory = user.subscriptionTier === 'premium'
    ? await getUserMemory(user.id)
    : null;

  const systemPrompt = chat.systemPrompt || `You are a helpful AI assistant.${
    memory ? `\n\nKnown facts about the user:\n${memory.map(m => `- ${m.value}`).join('\n')}` : ''
  }`;

  // Create message history
  const messageHistory = [
    { role: 'system', content: systemPrompt },
    ...chat.messages.map(m => ({ role: m.role, content: m.content })),
    { role: 'user', content },
  ];

  // Save user message
  const userMessage = await db.insert(messages).values({
    chatId,
    role: 'user',
    content,
  }).returning();

  // Stream response
  reply.raw.setHeader('Content-Type', 'text/event-stream');
  reply.raw.setHeader('Cache-Control', 'no-cache');
  reply.raw.setHeader('Connection', 'keep-alive');

  let fullResponse = '';
  let tokensUsed = 0;

  try {
    const stream = openRouterService.streamChat(messageHistory, chat.model);

    for await (const chunk of stream) {
      fullResponse += chunk;
      reply.raw.write(` ${JSON.stringify({ chunk })}\n\n`);
    }

    // Save assistant message
    await db.insert(messages).values({
      chatId,
      role: 'assistant',
      content: fullResponse,
      model: chat.model,
      tokensUsed,
    });

    // Auto-generate title for first message
    if (chat.messages.length === 0) {
      const title = await generateTitle(content, fullResponse);
      await db.update(chats).set({ title }).where(eq(chats.id, chatId));
    }

    // Update usage stats
    await incrementUsage(user.id);

    reply.raw.write(' [DONE]\n\n');
    reply.raw.end();
  } catch (error) {
    reply.raw.write(` ${JSON.stringify({ error: error.message })}\n\n`);
    reply.raw.end();
  }
});
```

### YooKassa Integration
```typescript
// services/api/src/services/payment.service.ts
import { YooKassa } from 'yookassa';

export class PaymentService {
  private yookassa = new YooKassa({
    shopId: process.env.YOOKASSA_SHOP_ID,
    secretKey: process.env.YOOKASSA_SECRET_KEY,
  });

  async createSubscription(userId: string) {
    const payment = await this.yookassa.createPayment({
      amount: { value: '9.99', currency: 'RUB' },
      confirmation: { type: 'redirect', return_url: `${process.env.APP_URL}/payment/success` },
      capture: true,
      description: 'Premium –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 1 –º–µ—Å—è—Ü (7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ)',
      meta { userId, plan: 'premium' },
    });

    await db.insert(subscriptions).values({
      userId,
      provider: 'yookassa',
      providerId: payment.id,
      status: 'pending',
      plan: 'premium',
      priceAmount: 999, // 9.99 RUB –≤ –∫–æ–ø–µ–π–∫–∞—Ö
      currentPeriodStart: new Date(),
      currentPeriodEnd: addMonths(new Date(), 1),
    });

    return payment.confirmation.confirmation_url;
  }

  async handleWebhook(event: any) {
    if (event.event === 'payment.succeeded') {
      const { userId } = event.object.metadata;
      
      // Activate subscription with 7 days trial
      await db.update(users)
        .set({
          subscriptionTier: 'premium',
          subscriptionExpiresAt: addDays(new Date(), 7),
        })
        .where(eq(users.id, userId));

      await db.update(subscriptions)
        .set({ status: 'active' })
        .where(eq(subscriptions.userId, userId));
    }
  }
}
```

---

## State Management & API Integration

### TanStack Query Hooks
```typescript
// packages/api-client/src/hooks/useChats.ts
export function useChats() {
  return useQuery({
    queryKey: ['chats'],
    queryFn: async () => {
      const res = await fetch('/api/chats');
      return res.json();
    },
  });
}

export function useChat(chatId: string) {
  return useQuery({
    queryKey: ['chat', chatId],
    queryFn: async () => {
      const res = await fetch(`/api/chats/${chatId}`);
      return res.json();
    },
    enabled: !!chatId,
  });
}

export function useSendMessage(chatId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (message: { content: string }) => {
      // Optimistic update
      queryClient.setQueryData(['chat', chatId], (old: any) => ({
        ...old,
        messages: [...old.messages, { role: 'user', content: message.content, createdAt: new Date() }],
      }));

      // Stream response via SSE
      const eventSource = new EventSource(`/api/chats/${chatId}/messages`, {
        method: 'POST',
        body: JSON.stringify(message),
      });

      return new Promise((resolve, reject) => {
        let fullResponse = '';

        eventSource.onmessage = (event) => {
          if (event.data === '[DONE]') {
            eventSource.close();
            resolve(fullResponse);
            return;
          }

          const { chunk } = JSON.parse(event.data);
          fullResponse += chunk;

          // Update streaming message in real-time
          queryClient.setQueryData(['chat', chatId], (old: any) => {
            const messages = [...old.messages];
            const lastMessage = messages[messages.length - 1];
            
            if (lastMessage?.role === 'assistant' && lastMessage.isStreaming) {
              lastMessage.content += chunk;
            } else {
              messages.push({ role: 'assistant', content: chunk, isStreaming: true });
            }

            return { ...old, messages };
          });
        };

        eventSource.onerror = (error) => {
          eventSource.close();
          reject(error);
        };
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['chat', chatId]);
      queryClient.invalidateQueries(['chats']);
    },
  });
}
```

### Zustand Store (–¥–ª—è UI state)
```typescript
// packages/ui/src/store/useUIStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface UIState {
  theme: 'light' | 'dark' | 'auto';
  sidebarCollapsed: boolean;
  density: 'comfortable' | 'compact';
  setTheme: (theme: 'light' | 'dark' | 'auto') => void;
  toggleSidebar: () => void;
  setDensity: (density: 'comfortable' | 'compact') => void;
}

export const useUIStore = create<UIState>()(
  persist(
    (set) => ({
      theme: 'auto',
      sidebarCollapsed: false,
      density: 'comfortable',
      setTheme: (theme) => set({ theme }),
      toggleSidebar: () => set((state) => ({ sidebarCollapsed: !state.sidebarCollapsed })),
      setDensity: (density) => set({ density }),
    }),
    { name: 'ui-store' }
  )
);
```

---

## UX/UI Design System

### Design Tokens
```typescript
// packages/config/tailwind.config.ts
export default {
  theme: {
    extend: {
      colors: {
        // Model brand colors
        'gpt': '#10a37f',      // OpenAI green
        'claude': '#d4a373',    // Anthropic orange
        'gemini': '#4285f4',    // Google blue
        'deepseek': '#8b5cf6',  // Purple
        'grok': '#000000',      // Black
        
        // App colors
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        // ... shadcn/ui color system
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace'],
      },
      animation: {
        'typing': 'blink 1s infinite',
      },
    },
  },
};
```

### Component Variants (shadcn/ui pattern)
```typescript
// packages/ui/src/atoms/Button.tsx
import { cva, type VariantProps } from 'class-variance-authority';

const buttonVariants = cva(
  'inline-flex items-center justify-center rounded-md font-medium transition-colors',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        outline: 'border border-input hover:bg-accent',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-9 px-3',
        lg: 'h-11 px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {}

export const Button = ({ className, variant, size, ...props }: ButtonProps) => {
  return (
    <button
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  );
};
```

---

## Testing Strategy

### Unit Tests
```typescript
// packages/ui/src/molecules/__tests__/MessageBubble.test.tsx
import { render, screen } from '@testing-library/react';
import { MessageBubble } from '../MessageBubble';

describe('MessageBubble', () => {
  it('renders user message correctly', () => {
    render(
      <MessageBubble
        message={{
          id: '1',
          role: 'user',
          content: 'Hello, AI!',
          createdAt: new Date(),
        }}
      />
    );

    expect(screen.getByText('Hello, AI!')).toBeInTheDocument();
  });

  it('renders assistant message with actions', () => {
    render(
      <MessageBubble
        message={{
          id: '2',
          role: 'assistant',
          content: 'Hello! How can I help?',
          model: 'gpt-4',
          createdAt: new Date(),
        }}
      />
    );

    expect(screen.getByText('Hello! How can I help?')).toBeInTheDocument();
    expect(screen.getByLabelText('Copy message')).toBeInTheDocument();
    expect(screen.getByLabelText('Regenerate')).toBeInTheDocument();
  });

  it('renders markdown content', () => {
    render(
      <MessageBubble
        message={{
          id: '3',
          role: 'assistant',
          content: '```python\nprint("Hello")\n```',
          createdAt: new Date(),
        }}
      />
    );

    expect(screen.getByText('print("Hello")')).toHaveClass('language-python');
  });
});
```

### Integration Tests
```typescript
// services/api/src/__tests__/chat.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { app } from '../index';

describe('Chat API', () => {
  let authToken: string;
  let chatId: string;

  beforeAll(async () => {
    // Create test user and get auth token
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/register',
      payload: { email: 'test@example.com', password: 'password123' },
    });
    authToken = res.json().token;
  });

  it('creates a new chat', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/chats',
      headers: { Authorization: `Bearer ${authToken}` },
      payload: { model: 'gpt-4', title: 'Test Chat' },
    });

    expect(res.statusCode).toBe(201);
    chatId = res.json().id;
  });

  it('sends a message and receives streaming response', async () => {
    const res = await app.inject({
      method: 'POST',
      url: `/api/chats/${chatId}/messages`,
      headers: { Authorization: `Bearer ${authToken}` },
      payload: { content: 'Hello!' },
    });

    expect(res.statusCode).toBe(200);
    expect(res.headers['content-type']).toContain('text/event-stream');
  });

  afterAll(async () => {
    await app.close();
  });
});
```

### E2E Tests (Playwright)
```typescript
// apps/web/e2e/chat-flow.spec.ts
import { test, expect } from '@playwright/test';

test('complete chat flow', async ({ page }) => {
  // 1. Login
  await page.goto('/login');
  await page.fill('[name=email]', 'test@example.com');
  await page.fill('[name=password]', 'password123');
  await page.click('button[type=submit]');

  // 2. Create new chat
  await expect(page).toHaveURL('/chat');
  await page.click('[data-testid=new-chat]');

  // 3. Select model
  await page.click('[data-testid=model-selector]');
  await page.click('text=GPT-4');

  // 4. Send message
  await page.fill('[data-testid=message-input]', 'Explain React in one sentence');
  await page.press('[data-testid=message-input]', 'Enter');

  // 5. Wait for streaming response
  await expect(page.locator('[data-testid=assistant-message]').first()).toBeVisible();
  await page.waitForSelector('[data-testid=message-actions]');

  // 6. Verify actions work
  await page.click('[data-testid=copy-button]');
  await expect(page.locator('text=Copied!')).toBeVisible();

  // 7. Regenerate
  await page.click('[data-testid=regenerate-button]');
  await expect(page.locator('[data-testid=loading-indicator]')).toBeVisible();
});

test('freemium limit enforcement', async ({ page }) => {
  await page.goto('/chat');
  
  // Send 50 messages (free tier limit)
  for (let i = 0; i < 50; i++) {
    await page.fill('[data-testid=message-input]', `Message ${i + 1}`);
    await page.press('[data-testid=message-input]', 'Enter');
    await page.waitForSelector('[data-testid=assistant-message]');
  }

  // 51st message should trigger upgrade prompt
  await page.fill('[data-testid=message-input]', 'One more message');
  await page.press('[data-testid=message-input]', 'Enter');
  await expect(page.locator('text=Upgrade to premium')).toBeVisible();
});
```

---

## CI/CD Pipeline

### GitHub Actions Workflow
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm type-check

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:latest
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
      redis:
        image: redis:7-alpine
    
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:unit --coverage
      - run: pnpm test:integration
      
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json

  build-web:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm build --filter=web
      
      - uses: actions/upload-artifact@v3
        with:
          name: web-build
          path: apps/web/.next

  build-mobile:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm build --filter=mobile
      
      # EAS Build (only on main branch)
      - name: Setup Expo
        if: github.ref == 'refs/heads/main'
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Build iOS
        if: github.ref == 'refs/heads/main'
        run: eas build --platform ios --non-interactive --no-wait
      
      - name: Build Android
        if: github.ref == 'refs/heads/main'
        run: eas build --platform android --non-interactive --no-wait

  e2e:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
      
      - run: pnpm install --frozen-lockfile
      - run: npx playwright install --with-deps
      - run: pnpm test:e2e
      
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/

  deploy:
    runs-on: ubuntu-latest
    needs: [build-web, e2e]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      # Deploy Next.js to Vercel
      - name: Deploy Web
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
      
      # Deploy API to Railway
      - name: Deploy API
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: api
```

---

## –ê–≥–µ–Ω—Ç—ã –∏ –∏—Ö —Ä–æ–ª–∏

### 1. –ê–†–•–ò–¢–ï–ö–¢–û–† (@architect)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –≤—ã–±–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- –î–∏–∑–∞–π–Ω database schema –∏ API contracts
- Code review –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–ö–æ–≥–¥–∞ –æ–±—Ä–∞—â–∞—Ç—å—Å—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π major —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ data model –∏–ª–∏ API structure
- Performance bottlenecks
- –í—ã–±–æ—Ä –º–µ–∂–¥—É —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏

### 2. FRONTEND –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö (@frontend)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (web + mobile)
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è state management –∏ API integration
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è bundle size –∏ rendering performance
- Responsive design –∏ cross-browser compatibility
- Accessibility (WCAG 2.1 AA compliance)

**–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∞:**
- TypeScript strict mode
- Functional components + React hooks
- Custom hooks –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- Atomic design –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Storybook –¥–ª—è UI documentation

### 3. BACKEND –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö (@backend)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ API endpoints (RESTful)
- Database queries –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (Drizzle ORM)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è OpenRouter API –∏ streaming responses
- –ü–ª–∞—Ç–µ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ (YooKassa webhooks)
- Rate limiting –∏ security middleware

**–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∞:**
- TypeScript strict mode
- Request/response validation (Zod schemas)
- Error handling —Å meaningful messages
- Logging —Å structured data (Pino)
- Database transactions –¥–ª—è critical operations

### 4. DEVOPS –ò–ù–ñ–ï–ù–ï–† (@devops)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker –æ–∫—Ä—É–∂–µ–Ω–∏—è (dev/prod)
- CI/CD pipeline –≤ GitHub Actions
- Database migrations —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- Monitoring setup (Sentry, Vercel Analytics)
- Backup –∏ disaster recovery

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**
- Zero-downtime deployments
- Automated testing –≤ CI
- Environment variables management
- Cost optimization (caching, CDN)

### 5. QA –¢–ï–°–¢–ò–†–û–í–©–ò–ö (@qa)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- –ù–∞–ø–∏—Å–∞–Ω–∏–µ unit/integration/e2e —Ç–µ—Å—Ç–æ–≤
- Test coverage monitoring (min 70%)
- Manual testing –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö flows
- Bug reporting —Å reproducible steps
- Performance testing (Lighthouse, load tests)

**Testing priorities:**
1. Auth flow (sign up, login, OAuth)
2. Chat creation –∏ messaging
3. Payment flow (trial ‚Üí paid)
4. Rate limiting enforcement
5. Cross-browser compatibility

### 6. UX/UI –î–ò–ó–ê–ô–ù–ï–† (@designer)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- UI/UX design –≤ Figma
- Design system –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (tokens, components)
- User flow –¥–∏–∞–≥—Ä–∞–º–º—ã
- Accessibility audit
- A/B test designs –¥–ª—è conversion optimization

**Deliverables:**
- Figma prototypes —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
- Component library –≤ sync —Å code
- Design tokens export –¥–ª—è Tailwind
- Animation specs (Lottie files)

### 7. PRODUCT MANAGER (@pm)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- Feature prioritization
- User feedback analysis
- Metrics tracking (conversion, retention, churn)
- Roadmap planning
- A/B test –≥–∏–ø–æ—Ç–µ–∑—ã

**Key metrics:**
- Free ‚Üí Paid conversion rate (target: 7%)
- DAU/MAU ratio (target: 0.4)
- Average messages per user per day
- Churn rate (target: <5% monthly)

### 8. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ü–ò–°–ê–¢–ï–õ–¨ (@docs)
**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
- README –¥–ª—è –∫–∞–∂–¥–æ–≥–æ package/app
- API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (OpenAPI spec)
- User guides –∏ tutorials
- Changelog maintenance
- Code comments –¥–ª—è complex logic

**Documentation structure:**
```
docs/
‚îú‚îÄ‚îÄ README.md              # Project overview
‚îú‚îÄ‚îÄ ARCHITECTURE.md        # System design
‚îú‚îÄ‚îÄ API.md                 # API reference
‚îú‚îÄ‚îÄ SETUP.md               # Local development setup
‚îú‚îÄ‚îÄ DEPLOYMENT.md          # Deployment guide
‚îú‚îÄ‚îÄ USER_GUIDE.md          # End-user documentation
‚îî‚îÄ‚îÄ CONTRIBUTING.md        # Contribution guidelines
```

---

## Workflow –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã

### Git Flow
```
main          (production)
  ‚Üë
develop       (integration)
  ‚Üë
feature/*     (–Ω–æ–≤—ã–µ —Ñ–∏—á–∏)
bugfix/*      (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–æ–≤)
hotfix/*      (—Å—Ä–æ—á–Ω—ã–µ production fixes)
```

### Feature Development Process
1. Create feature branch –æ—Ç `develop`
   ```bash
   git checkout -b feature/chat-branching
   ```

2. Development
   - Write code + unit tests
   - Update documentation
   - Test locally

3. Create Pull Request
   - Fill PR template (—á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ, –∫–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å)
   - Automated checks run (lint, type-check, tests)
   - Request review –æ—Ç relevant –∞–≥–µ–Ω—Ç–∞ (@frontend, @backend, etc.)

4. Code Review
   - –ú–∏–Ω–∏–º—É–º 1 approval required
   - Address feedback
   - Green CI checks

5. Merge
   - Squash commits –≤ develop
   - Auto-deploy –Ω–∞ staging
   - QA testing

6. Release
   - Merge develop ‚Üí main
   - Auto-deploy –Ω–∞ production
   - Create git tag (v1.0.0)

### Code Review Checklist
- [ ] Code follows style guide (ESLint/Prettier)
- [ ] TypeScript types –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `any`
- [ ] Tests coverage ‚â• 70% –¥–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
- [ ] No console.logs –≤ production code
- [ ] Error handling present
- [ ] Documentation updated
- [ ] Performance considerations (–º–µ–º–æ–∏–∑–∞—Ü–∏—è, lazy loading)
- [ ] Accessibility (keyboard navigation, ARIA labels)
- [ ] Security (no hardcoded secrets, input validation)

---

## Environment Variables

### Apps/Services `.env` structure
```bash
# apps/web/.env.local
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_APPWRITE_ENDPOINT=http://localhost/v1
NEXT_PUBLIC_APPWRITE_PROJECT_ID=xxx

# apps/mobile/.env
EXPO_PUBLIC_API_URL=http://localhost:3001

# services/api/.env
DATABASE_URL=postgresql://user:pass@localhost:5432/aiplatform
REDIS_URL=redis://localhost:6379

OPENROUTER_API_KEY=sk-or-xxx
OPENROUTER_APP_URL=https://yourapp.com

YOOKASSA_SHOP_ID=xxx
YOOKASSA_SECRET_KEY=xxx

APPWRITE_ENDPOINT=http://localhost/v1
APPWRITE_PROJECT_ID=xxx
APPWRITE_API_KEY=xxx

SENTRY_DSN=https://xxx@sentry.io/xxx
NODE_ENV=development
```

### Secret Management
- **Local:** `.env.local` (gitignored)
- **CI/CD:** GitHub Secrets
- **Production:** Railway/Vercel environment variables
- **Rotation:** Quarterly –¥–ª—è API keys

---

## Freemium Business Model

### Free Tier (7 –¥–Ω–µ–π trial, –ø–æ—Ç–æ–º limited)
```typescript
const FREE_LIMITS = {
  messagesPerDay: 50,
  availableModels: ['gpt-4o-mini', 'claude-haiku', 'gemini-flash'],
  chatHistoryDays: 7,
  comparisonMode: false,
  customSystemPrompts: false,
  priorityQueue: false,
  ttsVoiceLimit: 5,
};
```

### Premium Tier ($9.99/–º–µ—Å—è—Ü, 7 –¥–Ω–µ–π trial)
```typescript
const PREMIUM_FEATURES = {
  messagesPerDay: Infinity,
  availableModels: 'all', // including GPT-4, Claude Opus, o1
  chatHistoryDays: Infinity,
  comparisonMode: true, // side-by-side 2-3 models
  customSystemPrompts: true,
  priorityQueue: true, // faster response times
  ttsVoiceLimit: Infinity,
  advancedParams: true, // temperature, top-p control
  exportChats: true, // PDF, Markdown
  crossChatMemory: true,
};
```

### Conversion Strategy
1. **Onboarding:** Show premium features during tour
2. **Usage triggers:**
   - After 40/50 messages ‚Üí "10 messages left today"
   - Hit limit ‚Üí Interstitial with upgrade CTA
   - Try premium model ‚Üí "Unlock GPT-4 with premium"
3. **Email nurture:**
   - Day 3: Feature highlight email
   - Day 5: "2 days left in trial" reminder
   - Day 7: "Subscribe now" with limited-time bonus
4. **In-app prompts:**
   - Every 5th chat ‚Üí Subtle "Try comparison mode" banner
   - Settings page ‚Üí Premium features preview

---

## Performance Optimization

### Web Performance Targets (Lighthouse)
- Performance: > 90
- Accessibility: 100
- Best Practices: 100
- SEO: 100

### Optimization Techniques
1. **Code Splitting**
   ```typescript
   // Dynamic imports –¥–ª—è heavy components
   const ChatInterface = dynamic(() => import('./ChatInterface'), {
     loading: () => <ChatSkeleton />,
   });
   ```

2. **Image Optimization**
   - Next.js Image component (auto WebP, lazy load)
   - SVG –¥–ª—è icons (–≤–º–µ—Å—Ç–æ PNG)
   - Avatar placeholders –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏

3. **Bundle Size**
   - Tree-shaking –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞
   - –ê–Ω–∞–ª–∏–∑ bundle —Å `@next/bundle-analyzer`
   - Lazy load –º–æ–¥–∞–ª–µ–π –∏ drawer components

4. **Caching Strategy**
   - Static assets: 1 year cache (immutable)
   - API responses: Stale-while-revalidate
   - Chat messages: React Query cache (5 min)
   - User profile: React Query cache (persistent)

5. **Database Optimization**
   - Indexes –Ω–∞ frequently queried columns (userId, chatId)
   - Pagination –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ —á–∞—Ç–æ–≤ (limit 50)
   - Connection pooling (PgBouncer)
   - Read replicas –¥–ª—è analytics queries

---

## Security Best Practices

### Authentication & Authorization
- JWT tokens (short-lived: 15 min) + Refresh tokens (long-lived: 30 days)
- HttpOnly cookies –¥–ª—è refresh tokens (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
- CSRF tokens –¥–ª—è state-changing requests
- Rate limiting –ø–æ IP –∏ userId

### Data Protection
- Bcrypt –¥–ª—è –ø–∞—Ä–æ–ª–µ–π (cost factor: 12)
- Encryption at rest –¥–ª—è sensitive data (pgcrypto)
- TLS 1.3 –¥–ª—è transit encryption
- Secrets –≤ environment variables (never –≤ code)

### Input Validation
```typescript
// Zod schemas –¥–ª—è –≤—Å–µ—Ö API requests
const sendMessageSchema = z.object({
  content: z.string().min(1).max(32000),
  chatId: z.string().uuid(),
  attachments: z.array(z.object({
    url: z.string().url(),
    type: z.enum(['image', 'pdf', 'document']),
  })).optional(),
});

// Usage –≤ route handler
app.post('/messages', async (req, reply) => {
  const validated = sendMessageSchema.parse(req.body); // throws if invalid
  // ... process
});
```

### Content Security Policy (CSP)
```typescript
// next.config.js
const cspHeader = `
  default-src 'self';
  script-src 'self' 'unsafe-eval' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' blob:  https:;
  font-src 'self';
  connect-src 'self' https://openrouter.ai https://api.yookassa.ru;
  frame-ancestors 'none';
`;
```

---

## Monitoring & Observability

### Error Tracking (Sentry)
```typescript
// apps/web/app/error.tsx
'use client';
import * as Sentry from '@sentry/nextjs';
import { useEffect } from 'react';

export default function Error({ error }: { error: Error }) {
  useEffect(() => {
    Sentry.captureException(error);
  }, [error]);

  return <ErrorFallback />;
}
```

### Analytics (PostHog)
```typescript
// Track key events
posthog.capture('chat_created', {
  model: 'gpt-4',
  source: 'new_chat_button',
});

posthog.capture('message_sent', {
  model: 'claude-3.5-sonnet',
  messageLength: 150,
  hasAttachments: false,
});

posthog.capture('subscription_started', {
  plan: 'premium',
  trial: true,
});
```

### Performance Monitoring
```typescript
// Web Vitals tracking
import { onCLS, onFID, onLCP } from 'web-vitals';

onCLS(console.log);
onFID(console.log);
onLCP(console.log);

// API response time tracking
app.addHook('onResponse', (req, reply, done) => {
  const responseTime = reply.getResponseTime();
  logger.info({ 
    url: req.url, 
    method: req.method, 
    statusCode: reply.statusCode,
    responseTime 
  });
  done();
});
```

---

## –ü—Ä–∞–≤–∏–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–æ–≤

### –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –∞–≥–µ–Ω—Ç—É
```
@<agent>: <–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏>

–ö–æ–Ω—Ç–µ–∫—Å—Ç: <—Ç–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è, —á—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ>
–ó–∞–¥–∞—á–∞: <–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å>
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: <—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã>
Acceptance Criteria:
- [ ] –ö—Ä–∏—Ç–µ—Ä–∏–π 1
- [ ] –ö—Ä–∏—Ç–µ—Ä–∏–π 2
Expected Output: <—á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ>
```

### –ü—Ä–∏–º–µ—Ä—ã

**–ó–∞–ø—Ä–æ—Å –∫ @frontend:**
```
@frontend: Implement model comparison mode UI

–ö–æ–Ω—Ç–µ–∫—Å—Ç: User can select multiple models in settings, backend API supports parallel requests
–ó–∞–¥–∞—á–∞: Create split-screen UI to display 2-3 model responses side-by-side
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- Must work on mobile (vertical stack) and desktop (horizontal split)
- Each panel shows model name, avatar, response
- Synchronized scrolling
- Individual copy/regenerate actions per model
Acceptance Criteria:
- [ ] Responsive layout (mobile vertical, desktop horizontal)
- [ ] Max 3 models simultaneously
- [ ] Accessible (keyboard navigation, screen reader support)
Expected Output: ComparisonView component + integration in ChatInterface
```

**–ó–∞–ø—Ä–æ—Å –∫ @backend:**
```
@backend: Implement subscription renewal cron job

–ö–æ–Ω—Ç–µ–∫—Å—Ç: YooKassa webhooks handle initial subscription, –Ω–æ –Ω–µ auto-renewal
–ó–∞–¥–∞—á–∞: Create scheduled job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ renewal –ø–æ–¥–ø–∏—Å–æ–∫
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- Run daily at 02:00 UTC
- Check subscriptions expiring in next 24h
- Attempt renewal via YooKassa API
- Send email notification on success/failure
- Update database subscription status
Acceptance Criteria:
- [ ] Cron job —Å error handling
- [ ] Transactional email integration (Resend)
- [ ] Database transaction –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
- [ ] Logging –¥–ª—è audit trail
Expected Output: Cron job service + tests
```

---

## Development Workflow

### –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã (Setup)
```bash
# 1. Clone repository
git clone https://github.com/your-org/ai-chat-platform.git
cd ai-chat-platform

# 2. Install dependencies
pnpm install

# 3. Setup environment variables
cp .env.example .env.local
# –ó–∞–ø–æ–ª–Ω–∏—Ç—å API keys

# 4. Start Docker services
docker-compose up -d

# 5. Run database migrations
pnpm db:migrate

# 6. Seed database (optional)
pnpm db:seed

# 7. Start development servers
pnpm dev  # Turborepo –∑–∞–ø—É—Å—Ç–∏—Ç –≤—Å–µ apps –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
```

### Common Commands
```bash
# Development
pnpm dev                      # Start all apps
pnpm dev --filter=web        # Start —Ç–æ–ª—å–∫–æ web app
pnpm dev --filter=mobile     # Start —Ç–æ–ª—å–∫–æ mobile app

# Building
pnpm build                    # Build all apps
pnpm build --filter=api      # Build —Ç–æ–ª—å–∫–æ API service

# Testing
pnpm test                     # Run all tests
pnpm test:unit               # Unit tests only
pnpm test:integration        # Integration tests only
pnpm test:e2e                # E2E tests (Playwright)
pnpm test:watch              # Watch mode

# Code Quality
pnpm lint                     # Lint all packages
pnpm lint:fix                # Auto-fix linting issues
pnpm type-check              # TypeScript check
pnpm format                  # Prettier format

# Database
pnpm db:migrate              # Run migrations
pnpm db:rollback             # Rollback last migration
pnpm db:studio               # Open Drizzle Studio (DB GUI)

# Mobile (Expo)
cd apps/mobile
npx expo start               # Start Expo dev server
npx expo start --ios         # Start iOS simulator
npx expo start --android     # Start Android emulator
eas build --platform ios     # Build iOS app (EAS)
eas submit --platform ios    # Submit to App Store
```

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (MVP ‚Üí v1.0 ‚Üí v2.0)

### MVP (6-8 –Ω–µ–¥–µ–ª—å)
**Must-have:**
- [ ] Auth (email/password + Google OAuth)
- [ ] Chat creation + messaging
- [ ] OpenRouter integration (5 –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π)
- [ ] Basic UI (web + mobile)
- [ ] Free tier —Å rate limiting (50 msg/day)
- [ ] Streaming responses (SSE)
- [ ] Chat history (last 7 days –¥–ª—è free)
- [ ] Basic settings (theme, density)

**Nice-to-have (cut if time):**
- Folders/tags
- Advanced model parameters
- TTS

### v1.0 (3-4 –Ω–µ–¥–µ–ª–∏ –ø–æ—Å–ª–µ MVP)
**Focus: Monetization**
- [ ] Premium subscription (YooKassa integration)
- [ ] Webhook handling –¥–ª—è payment events
- [ ] Email notifications (trial ending, payment success)
- [ ] Usage analytics dashboard –¥–ª—è users
- [ ] Comparison mode (premium feature)
- [ ] Export chats (PDF, Markdown)
- [ ] All OpenRouter models (20+)

### v2.0 (Roadmap)
**Advanced features:**
- [ ] Cross-chat memory (AI remembers user preferences)
- [ ] Collaborative chats (invite other users)
- [ ] Voice input + TTS (ElevenLabs)
- [ ] Image generation (DALL-E, Midjourney integration)
- [ ] Custom AI personas/assistants
- [ ] API access –¥–ª—è developers (paid tier)
- [ ] Telegram/Discord bot integration
- [ ] Enterprise plan (team management, SSO)

---

## –§–∏–Ω–∞–ª—å–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:
1. **–ê–Ω–∞–ª–∏–∑:** –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ –∞–≥–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–æ–≤–ª–µ—á–µ–Ω—ã
2. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–∞–∑–±–µ–π –∑–∞–¥–∞—á—É –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
3. **Execution:** –°–ª–µ–¥—É–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º code standards
4. **Testing:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å —Ç–µ—Å—Ç—ã (unit/integration)
5. **Documentation:** –û–±–Ω–æ–≤–∏ README/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
6. **Review:** Self-review –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º PR

### Code Standards
- **TypeScript:** Strict mode, –∏–∑–±–µ–≥–∞–π `any`
- **Naming:** camelCase (variables/functions), PascalCase (components/types), SCREAMING_SNAKE_CASE (constants)
- **Functions:** Small, single-responsibility, max 50 lines
- **Components:** Functional, hooks-based, –∏–∑–≤–ª–µ–∫–∞–π –ª–æ–≥–∏–∫—É –≤ custom hooks
- **Errors:** Always handle errors, meaningful messages
- **Logging:** Structured logs (Pino), include context (userId, chatId)

### Performance Mindset
- –ò–∑–±–µ–≥–∞–π premature optimization, –Ω–æ –ø–æ–º–Ω–∏ –ø—Ä–æ:
  - Lazy loading –¥–ª—è heavy components
  - Memoization –¥–ª—è expensive calculations (useMemo, useCallback)
  - Virtualization –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ (react-window)
  - Debounce –¥–ª—è search inputs
  - Caching —Å React Query

### Security Mindset
- Never trust user input (validate everything)
- Never expose secrets (use env variables)
- Always sanitize HTML (use DOMPurify –¥–ª—è user content)
- Rate limit –≤—Å–µ public endpoints
- Log security
